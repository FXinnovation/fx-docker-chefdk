#!/bin/bash
set -e -x

# Installing cURL
apt-get update
apt-get install -y curl

# Downloading chefdk
curl -sSlo /resources/chefdk.deb \
  https://packages.chef.io/files/stable/chefdk/${CHEFDK_VERSION}/ubuntu/16.04/chefdk_${CHEFDK_VERSION}-1_amd64.deb

# Installing chefdk
dpkg -i /resources/chefdk.deb

# Installing stove
chef exec gem install stove -v ${STOVE_VERSION}

# CIS Hardening
sed -i -e "s/^PASS_MAX_DAYS\s99999/PASS_MAX_DAYS   60/" /etc/login.defs
sed -i -e "s/^PASS_MIN_DAYS\s0/PASS_MIN_DAYS	7/" /etc/login.defs
set -i -e "s/^UMASK\s022/UMASK	027/" /etc/login.defs

# Cleaning
apt-get remove --purge -y curl
apt-get clean
rm -rf /tmp/*
